<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LKR Finance Pro</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#1a73e8">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #1a73e8; --primary-dark: #0d47a1; --income-dark: #0f9d58; --expense-dark: #db4437;
            --bg: #f5f7fa; --card-bg: #ffffff; --text: #1f1f1f; --text-light: #5f6368; --border: #e0e0e0;
            --shadow: 0 4px 12px rgba(0,0,0,0.08); --radius: 18px; --gap: 1rem; --padding: 1rem;
        }
        [data-theme="dark"] {
            --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --text-light: #aaaaaa; --border: #333333;
            --shadow: 0 4px 12px rgba(0,0,0,0.3); --primary: #4d8ff5; --income-dark: #66bb6a; --expense-dark: #ef5350;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; font-size: 15px; min-height: 100vh; transition: background 0.3s ease; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 var(--padding); display: flex; flex-direction: column; gap: var(--gap); }
        header { background: var(--card-bg); padding: 1.25rem var(--padding); text-align: center; box-shadow: var(--shadow); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .app-title { font-size: clamp(1.5rem, 5vw, 1.8rem); font-weight: 800; color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .tabs { display: flex; background: var(--card-bg); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); padding: 0.35rem; gap: 0.35rem; }
        .tab { flex: 1; padding: clamp(0.6rem, 2vw, 0.75rem); text-align: center; font-weight: 600; font-size: clamp(0.8rem, 2.5vw, 0.9rem); color: var(--text-light); transition: all 0.3s ease; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.35rem; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(26,115,232,0.3); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border-radius: var(--radius); padding: clamp(1rem, 3vw, 1.25rem); box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; gap: var(--gap); transition: background 0.3s ease; }
        .card-header { display: flex; align-items: center; justify-content: space-between; font-weight: 700; font-size: clamp(1rem, 3vw, 1.1rem); color: var(--text); flex-wrap: wrap; gap: 0.5rem; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--gap); }
        .summary-card { background: var(--card-bg); padding: clamp(1rem, 3vw, 1.25rem); border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border); transition: transform 0.2s ease, background 0.3s ease; display: flex; flex-direction: column; justify-content: center; }
        .summary-card:active { transform: scale(0.98); }
        .summary-label { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-light); display: flex; align-items: center; justify-content: center; gap: 0.35rem; margin-bottom: 0.5rem; }
        .summary-value { font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 800; font-variant-numeric: tabular-nums; }
        .positive { color: var(--income-dark); } .negative { color: var(--expense-dark); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr auto; gap: clamp(0.5rem, 2vw, 0.75rem); align-items: end; }
        input, select { width: 100%; padding: clamp(0.75rem, 2.5vw, 0.85rem); border: 1.5px solid var(--border); border-radius: 12px; font: inherit; font-size: clamp(0.9rem, 2.5vw, 0.95rem); background: var(--card-bg); color: var(--text); transition: background 0.3s ease; }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: var(--card-bg); box-shadow: 0 0 0 3px rgba(26,115,232,0.15); }
        .amount-input { text-align: right; font-weight: 700; font-size: clamp(1rem, 3vw, 1.1rem); }
        .btn { background: var(--primary); color: white; border: none; padding: clamp(0.75rem, 2.5vw, 0.85rem) clamp(1rem, 3vw, 1.25rem); border-radius: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: clamp(0.85rem, 2.5vw, 0.95rem); min-height: 48px; box-shadow: 0 2px 8px rgba(26,115,232,0.3); transition: all 0.2s ease; white-space: nowrap; }
        .btn:active { transform: scale(0.96); }
        .btn-sm { padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.6rem, 2vw, 0.75rem); font-size: clamp(0.75rem, 2vw, 0.85rem); min-height: auto; box-shadow: none; }
        .btn-budget { background: linear-gradient(135deg, #667eea, #764ba2); }
        .transaction-list { display: flex; flex-direction: column; gap: clamp(0.5rem, 2vw, 0.75rem); }
        .transaction-card { background: var(--card-bg); border-radius: 14px; padding: clamp(0.85rem, 2.5vw, 1rem); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); transition: all 0.2s ease, background 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        .transaction-card:active { transform: scale(0.98); }
        .trans-left { flex: 1; min-width: 0; }
        .trans-date { font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-light); }
        .trans-cat { font-weight: 600; font-size: clamp(0.85rem, 2.5vw, 0.95rem); display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0; }
        .trans-desc { font-size: clamp(0.75rem, 2vw, 0.85rem); color: var(--text-light); }
        .trans-amount { font-weight: 800; font-size: clamp(1.1rem, 3vw, 1.2rem); font-variant-numeric: tabular-nums; white-space: nowrap; }
        .chart-container { position: relative; height: clamp(200px, 40vh, 260px); border-radius: var(--radius); overflow: hidden; background: var(--card-bg); padding: clamp(0.75rem, 2vw, 1rem); box-shadow: inset 0 1px 4px rgba(0,0,0,0.05); }
        .fab { position: fixed; bottom: clamp(1rem, 3vw, 1.5rem); right: clamp(1rem, 3vw, 1.5rem); background: var(--primary); color: white; width: clamp(50px, 12vw, 60px); height: clamp(50px, 12vw, 60px); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: clamp(1.2rem, 4vw, 1.6rem); box-shadow: 0 6px 20px rgba(26,115,232,0.4); z-index: 100; cursor: pointer; }
        #login-modal, #goals-modal, #budget-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--padding); }
        .modal-content { background: var(--card-bg); padding: clamp(1.5rem, 4vw, 2rem); border-radius: var(--radius); width: 100%; max-width: 420px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: var(--gap); transition: background 0.3s ease; }
        .modal-content h2 { font-size: clamp(1.2rem, 4vw, 1.4rem); color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .modal-content input { width: 100%; padding: clamp(0.75rem, 2.5vw, 0.85rem); border: 1.5px solid var(--border); border-radius: 12px; font-size: clamp(1rem, 3vw, 1.1rem); text-align: center; background: var(--card-bg); color: var(--text); }
        .emoji { font-size: clamp(1.1rem, 3vw, 1.2rem); }
        .total-row { padding: clamp(0.6rem, 2vw, 0.75rem) 0; text-align: right; font-weight: 700; font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .budget-progress { background: rgba(0,0,0,0.1); height: 10px; border-radius: 5px; overflow: hidden; margin: 0.5rem 0; }
        .budget-fill { height: 100%; background: linear-gradient(90deg, #4caf50, 8bc34a); border-radius: 5px; transition: width 0.6s ease; }
        .theme-toggle { position: fixed; top: 1rem; right: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 200; box-shadow: var(--shadow); }
        .biometric-btn { background: var(--income-dark); margin-top: 1rem; }
        .cloud-status { font-size: 0.8rem; color: var(--text-light); text-align: center; margin-top: 0.5rem; }
        .cloud-btn { background: #4285f4; margin-top: 0.5rem; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr 1fr; } .form-row > *:nth-child(5) { grid-column: 1 / -1; } }
        @media (max-width: 480px) { :root { --gap: 0.75rem; --padding: 0.75rem; } .form-row { grid-template-columns: 1fr; } .form-row > * { grid-column: 1 / -1; } .summary-grid { grid-template-columns: 1fr; } .tabs { flex-direction: column; padding: 0.25rem; } .tab { margin: 0.25rem 0; } .transaction-card { flex-direction: column; align-items: flex-start; } .trans-amount { margin-left: auto; } .card-header { flex-direction: column; align-items: flex-start; } .btn { width: 100%; } }
        @media (min-width: 1200px) { .container { max-width: 900px; } }
    </style>
</head>
<body>

<!-- LOGIN MODAL -->
<div id="login-modal">
    <div class="modal-content">
        <h2><i class="fas fa-shield-alt"></i> Secure Access</h2>
        <p style="color:var(--text-light);">Use biometric or password</p>

        <button id="biometric-btn" class="btn biometric-btn" style="display:none;" onclick="tryBiometric()">
            <i class="fas fa-fingerprint"></i> Unlock with Biometric
        </button>

        <div id="password-fallback">
            <input type="password" id="password-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button class="btn" onclick="loginWithPassword()">Unlock with Password</button>
            <p style="font-size:0.8rem; color:#999; margin-top:0.5rem;">Default: <strong>finance2025</strong></p>
        </div>

        <div id="cloud-status" class="cloud-status"></div>
    </div>
</div>

<!-- GOALS MODAL -->
<div id="goals-modal" style="display:none;">
    <div class="modal-content">
        <h2><i class="fas fa-bullseye"></i> Set Monthly Goals</h2>
        <p style="color:var(--text-light);">Enter budget limit per category</p>
        <div id="goals-form" style="max-height:60vh; overflow-y:auto; display:flex; flex-direction:column; gap:0.75rem;"></div>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button class="btn" style="flex:1; background:#666;" onclick="closeGoalsModal()">Cancel</button>
            <button class="btn" style="flex:1;" onclick="saveGoals()">Save</button>
        </div>
    </div>
</div>

<!-- BUDGET OVERVIEW MODAL -->
<div id="budget-modal" style="display:none;">
    <div class="modal-content">
        <h2><i class="fas fa-chart-pie"></i> Budget Overview</h2>
        <div id="budget-summary" style="text-align:left; max-height:65vh; overflow-y:auto;"></div>
        <button class="btn" style="margin-top:1rem;" onclick="closeBudgetModal()">Close</button>
    </div>
</div>

<!-- MAIN APP -->
<div id="app-content" style="display:none;">
    <header>
        <div class="app-title"><i class="fas fa-wallet"></i> LKR Finance Pro</div>
    </header>

    <!-- DARK MODE TOGGLE -->
    <div class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">ğŸŒ™</span>
    </div>

    <!-- CLOUD BACKUP BUTTON -->
    <div style="position:fixed; top:1rem; left:1rem; z-index:200;">
        <button class="btn btn-sm cloud-btn" onclick="backupToCloud()">
            <i class="fas fa-cloud-upload-alt"></i> Backup
        </button>
        <div id="backup-status" class="cloud-status" style="margin-top:0.25rem; font-size:0.7rem;"></div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="dashboard"><span class="emoji">ğŸ“Š</span> Dashboard</div>
            <div class="tab" data-tab="income"><span class="emoji">ğŸ’°</span> Income</div>
            <div class="tab" data-tab="expenses"><span class="emoji">ğŸ›’</span> Expenses</div>
        </div>

        <!-- DATE RANGE FILTER -->
        <div class="card" id="date-filter" style="margin-bottom:0.5rem; padding:0.75rem;">
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; font-weight:600; font-size:0.9rem;">
                <input type="date" id="filter-from" style="flex:1; min-width:120px;">
                <span style="color:var(--text-light);">to</span>
                <input type="date" id="filter-to" style="flex:1; min-width:120px;">
                <button class="btn btn-sm" style="background:var(--primary);" onclick="applyDateFilter()">
                    <i class="fas fa-filter"></i> Apply
                </button>
                <button class="btn btn-sm" style="background:#666;" onclick="resetDateFilter()">
                    <i class="fas fa-globe"></i> All Time
                </button>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label"><i class="fas fa-arrow-up"></i> Income</div>
                    <div class="summary-value positive" id="total-income">LKR 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label"><i class="fas fa-arrow-down"></i> Expenses</div>
                    <div class="summary-value negative" id="total-expenses">LKR 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label"><i class="fas fa-balance-scale"></i> Balance</div>
                    <div class="summary-value" id="net-balance">LKR 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label"><i class="fas fa-check-circle"></i> Status</div>
                    <div id="status-text" style="font-weight:700;">â€”</div>
                </div>
            </div>

            <div class="card">
                <button class="btn btn-budget" style="width:100%; font-size:1rem;" onclick="openBudgetModal()">
                    <i class="fas fa-chart-pie"></i> View Budget Overview
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <span><i class="fas fa-chart-line"></i> Monthly Trend</span>
                    <button class="btn btn-sm" style="background:var(--income-dark);" onclick="exportCSV()"><i class="fas fa-file-csv"></i> Export</button>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-history"></i> Recent Activity</div>
                <div id="recent-list" class="transaction-list"></div>
            </div>
        </div>

        <!-- INCOME TAB -->
        <div id="income" class="tab-content">
            <div class="card">
                <div class="card-header"><i class="fas fa-plus-circle"></i> Add Income</div>
                <div class="form-row">
                    <input type="date" id="inc-date" required>
                    <select id="inc-category" required>
                        <option value="">Category</option>
                        <option value="Salary">ğŸ“¥ Salary</option>
                        <option value="Freelance">ğŸ’¼ Freelance</option>
                        <option value="Investments">ğŸ“ˆ Investments</option>
                        <option value="Other">ğŸ Other</option>
                    </select>
                    <input type="text" id="inc-desc" placeholder="Note (optional)">
                    <input type="number" id="inc-amount" class="amount-input" placeholder="0.00" step="0.01" min="0">
                    <button class="btn" onclick="addIncome()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><i class="fas fa-list"></i> Income History</div>
                <div id="income-list" class="transaction-list"></div>
                <div class="total-row" style="color:var(--income-dark);">Total: <span id="income-total">LKR 0.00</span></div>
            </div>
        </div>

        <!-- EXPENSES TAB -->
        <div id="expenses" class="tab-content">
            <div class="card">
                <div class="card-header"><i class="fas fa-minus-circle"></i> Add Expense</div>
                <div class="form-row">
                    <input type="date" id="exp-date" required>
                    <select id="exp-category" required>
                        <option value="">Category</option>
                        <option value="Food & Dining">ğŸ² Food & Dining</option>
                        <option value="Transportation">ğŸšŒ Transport</option>
                        <option value="Utilities">âš¡ Utilities</option>
                        <option value="Health & Wellness">ğŸ‹ï¸ Health</option>
                        <option value="Entertainment">ğŸ¥ Fun</option>
                        <option value="Education">ğŸ“š Education</option>
                        <option value="Miscellaneous">ğŸ›ï¸ Other</option>
                    </select>
                    <input type="text" id="exp-desc" placeholder="Note (optional)">
                    <input type="number" id="exp-amount" class="amount-input" placeholder="0.00" step="0.01" min="0">
                    <button class="btn" onclick="addExpense()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><i class="fas fa-list"></i> Expense History</div>
                <div id="expense-list" class="transaction-list"></div>
                <div class="total-row" style="color:var(--expense-dark);">Total: <span id="expense-total">LKR 0.00</span></div>
            </div>
        </div>
    </div>
</div>

<!-- FAB (Edit Goals) -->
<div class="fab" onclick="openGoalsModal()"><i class="fas fa-cog"></i></div>

<script>
    const { DateTime } = luxon;
    let income = [], expenses = [], budgetGoals = {}, chartInstance = null;
    let filterFrom = null, filterTo = null;
    let db = null, user = null;

    // === PASTE YOUR FIREBASE CONFIG HERE ===
    const firebaseConfig = {
  apiKey: "AIzaSyCpc3QxeeP1OUu4XXv8GtbXq53-a69fxdQ",
  authDomain: "lkr-finance-pro.firebaseapp.com",
  projectId: "lkr-finance-pro",
  storageBucket: "lkr-finance-pro.firebasestorage.app",
  messagingSenderId: "77274353339",
  appId: "1:77274353339:web:c7b3b2711a5da69e87e39e"
};
    // ========================================

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    // DARK MODE
    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        document.getElementById('theme-icon').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
        saveToCloud(); // Auto backup on change
    }
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('theme-icon').textContent = 'â˜€ï¸';
    }

    // BIOMETRIC
    async function tryBiometric() {
        if (!window.PublicKeyCredential) return fallbackToPassword();
        if (!localStorage.getItem('biometricRegistered')) return fallbackToPassword();
        try {
            await navigator.credentials.get({ publicKey: { challenge: new Uint8Array(32) } });
            unlockApp();
        } catch { fallbackToPassword(); }
    }

    async function loginWithPassword() {
        if (document.getElementById('password-input').value === 'TCpg@2014') {
            try { await registerBiometric(); } catch {}
            unlockApp();
        } else alert('Wrong password');
    }

    async function registerBiometric() {
        if (!window.PublicKeyCredential || localStorage.getItem('biometricRegistered')) return;
        await navigator.credentials.create({ publicKey: { challenge: new Uint8Array(32), rp: { name: "LKR Finance" }, user: { id: new Uint8Array(16), name: "user", displayName: "User" }, pubKeyCredParams: [{ type: "public-key", alg: -7 }] } });
        localStorage.setItem('biometricRegistered', 'true');
    }

    function fallbackToPassword() {
        document.getElementById('biometric-btn').style.display = 'none';
        document.getElementById('password-fallback').style.display = 'block';
    }

    // CLOUD BACKUP
    async function initCloud() {
        try {
            user = await new Promise((resolve) => auth.signInAnonymously().then(u => resolve(u.user)));
            db = firestore.collection('users').doc(user.uid);
            document.getElementById('cloud-status').innerHTML = 'ğŸ”’ Connected';
            await restoreFromCloud();
        } catch (e) {
            document.getElementById('cloud-status').innerHTML = 'âš ï¸ Offline';
        }
    }

    async function backupToCloud() {
        if (!db) return;
        const data = {
            income, expenses, budgetGoals,
            theme: localStorage.getItem('theme') || 'light',
            timestamp: DateTime.now().toISO()
        };
        try {
            await db.set(data);
            document.getElementById('backup-status').textContent = 'âœ… Backed up';
            setTimeout(() => document.getElementById('backup-status').textContent = '', 2000);
        } catch (e) {
            document.getElementById('backup-status').textContent = 'âŒ Failed';
        }
    }

    async function restoreFromCloud() {
        if (!db) return;
        try {
            const snap = await db.get();
            if (snap.exists) {
                const data = snap.data();
                income = data.income || [];
                expenses = data.expenses || [];
                budgetGoals = data.budgetGoals || budgetGoals;
                if (data.theme) {
                    document.body.setAttribute('data-theme', data.theme);
                    document.getElementById('theme-icon').textContent = data.theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
                    localStorage.setItem('theme', data.theme);
                }
                saveToLocalStorage();
                renderAll();
                document.getElementById('cloud-status').innerHTML = `ğŸ“¥ Restored ${DateTime.fromISO(data.timestamp).toFormat('dd MMM yyyy HH:mm')}`;
            }
        } catch (e) { console.log("Restore failed", e); }
    }

    function saveToLocalStorage() {
        localStorage.setItem('income', JSON.stringify(income));
        localStorage.setItem('expenses', JSON.stringify(expenses));
        localStorage.setItem('budgetGoals', JSON.stringify(budgetGoals));
    }

    function unlockApp() {
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        initApp();
        initCloud();
    }

    // Show biometric if available
    window.addEventListener('load', () => {
        if (window.PublicKeyCredential && localStorage.getItem('biometricRegistered')) {
            document.getElementById('biometric-btn').style.display = 'flex';
        } else {
            fallbackToPassword();
        }
    });

    function initApp() {
        document.getElementById('inc-date').valueAsDate = new Date();
        document.getElementById('exp-date').valueAsDate = new Date();
        loadFromLocalStorage();
        initDateFilter();
        renderAll();
    }

    function loadFromLocalStorage() {
        income = JSON.parse(localStorage.getItem('income')) || [];
        expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        budgetGoals = JSON.parse(localStorage.getItem('budgetGoals')) || {
            'Food & Dining': 15000, 'Transportation': 8000, 'Utilities': 10000,
            'Health & Wellness': 5000, 'Entertainment': 6000, 'Education': 7000, 'Miscellaneous': 5000
        };
    }

    // [Rest of your existing functions: initDateFilter, applyDateFilter, etc.]
    // ... (all previous functions remain unchanged)

    // Auto backup on change
    const originalAdd = addTrans;
    addTrans = function(type) {
        originalAdd(type);
        backupToCloud();
    };
    const originalDelete = deleteItem;
    deleteItem = function(type, idx) {
        originalDelete(type, idx);
        backupToCloud();
    };
    const originalSaveGoals = saveGoals;
    saveGoals = function() {
        originalSaveGoals();
        backupToCloud();
    };

    // [Include all other functions: renderAll, renderIncome, etc.]
    // ... (same as before)

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered', reg))
                .catch(err => console.log('SW failed', err));
        });
    }
</script>
</body>
</html>
